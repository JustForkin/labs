'use strict';var canvas,info,debug,THREE,mainClick,mainDown,mainUp,mainMove,mainRay,v,shader,V={},TWEEN=TWEEN||null;V.AR8="undefined"!=typeof Uint8Array?Uint8Array:Array;V.AR16="undefined"!=typeof Uint16Array?Uint16Array:Array;V.AR32="undefined"!=typeof Float32Array?Float32Array:Array;V.PI=Math.PI;V.PI90=0.5*Math.PI;V.PI270=V.PI+V.PI90;V.TwoPI=2*Math.PI;V.ToRad=Math.PI/180;V.Resolution={w:1600,h:900,d:200,z:10,f:40};V.sqrt=Math.sqrt;V.abs=Math.abs;V.max=Math.max;V.pow=Math.pow;V.floor=Math.floor;
V.round=Math.round;V.lerp=function(a,b,c){return a+(b-a)*c};V.rand=function(a,b,c){return 1*V.lerp(a,b,Math.random()).toFixed(c||3)};V.randInt=function(a,b,c){return 1*V.lerp(a,b,Math.random()).toFixed(c||0)};V.MeshList="plane sphere skull skullhigh head woman babe".split(" ");V.Main=null;
V.View=function(a,b,c){window.top.main.previewTheme();this.dimentions={w:window.innerWidth,h:window.innerHeight,r:window.innerWidth/window.innerHeight};this.canvas=canvas;this.debug=debug;this.info=info;this.renderer=new THREE.WebGLRenderer({canvas:canvas,precision:"mediump",antialias:!0,alpha:!0,stencil:!1});this.renderer.setSize(this.dimentions.w,this.dimentions.h);this.renderer.setClearColor(0,0);this.renderer.autoClear=!1;this.clock=new THREE.Clock;this.z=null;this.scene=new THREE.Scene;this.nav=
new V.Nav(this,a,b,c);this.base=new THREE.Group;this.content=new THREE.Group;this.skinned=new THREE.Group;this.scene.add(this.base);this.scene.add(this.content);this.scene.add(this.skinned);this.initGeo();this.initMat();this.pool=new V.SeaPool;this.postEffect=null;this.deb="";this.f=[0,0,0,0];this.meshs=[];this.lines=[];this.anchors={};this.ps=[];this.model="skull";this.w=this.basic=null;this.isWithSerious=this.isW=!1;window.onresize=function(a){this.resize(a)}.bind(this)};
V.View.prototype={constructor:V.View,render:function(){this.w&&!this.isW&&this.w.isReady&&(this.wFun(),this.isW=!0);this.isWithSerious&&this.renderer.resetGLState();TWEEN&&TWEEN.update();THREE.AnimationHandler.update(this.clock.getDelta());null!==this.postEffect&&this.postEffect.isActive?this.postEffect.render():this.renderer.render(this.scene,this.nav.camera);var a=this.f;a[0]=Date.now();a[0]-1E3>a[1]&&(a[1]=a[0],a[3]=a[2],a[2]=0);a[2]++;this.debug.innerHTML="three "+a[3]+" fps"+this.deb},initGui:function(a){this.gui=
new V.Gui(a)},ssao:function(a){this.postEffect=new V.PostEffect(this,"ssao",a)},metaball:function(a){this.sceneBlob=new THREE.Scene;this.postEffect=new V.PostEffect(this,"metaball",!1,a)},deformSsao:function(a,b){this.postEffect.deformSsao(a,b)},resize:function(){this.dimentions.w=window.innerWidth;this.dimentions.h=window.innerHeight;this.dimentions.r=this.dimentions.w/this.dimentions.h;this.renderer.setSize(this.dimentions.w,this.dimentions.h);this.nav.camera.aspect=this.dimentions.r;this.nav.camera.updateProjectionMatrix();
null!==this.postEffect&&this.postEffect.isActive&&this.postEffect.resize(this.dimentions.w,this.dimentions.h)},colorBack:function(a){null!==this.postEffect&&this.renderer.setClearColor(a,1)},zone:function(){this.z=new THREE.Mesh(this.geo.ground,this.mat.zone);this.z.name="zone";this.z.scale.set(1,1,1);this.z.visible=!1;this.base.add(this.z)},addModel:function(a){null!==this.basic&&this.scene.remove(this.basic);"plane"===this.model?(this.basic=new THREE.Mesh(this.geo.ground,a),this.basic.geometry.computeTangents(),
this.basic.scale.set(50,50,50),this.scene.add(this.basic)):"sphere"===this.model?(this.basic=new THREE.Mesh(this.geo.sphereHigh,a),this.basic.scale.set(25,25,25),this.scene.add(this.basic)):(this.tmpmat=a,this.pool.load(this.model,this.onModelLoaded))},onModelLoaded:function(){var a=v.pool.meshes[v.model],b=new THREE.Geometry,c;for(c in a)b.merge(a[c].geometry);v.basic=new THREE.Mesh(V.TransGeo(b,!0),v.tmpmat);"skull"==v.model?v.basic.scale.set(10,10,-10):"skullhigh"==v.model?v.basic.scale.set(2,
2,-2):"head"==v.model?(v.basic.scale.set(8,8,-8),v.basic.position.y=-40):"woman"==v.model?(v.basic.scale.set(60,60,-60),v.basic.position.y=-37):v.basic.scale.set(1,1,-1);v.scene.add(v.basic)},basic:function(){this.basic=new THREE.Mesh(this.geo.ground,this.mat.base);this.basic.scale.set(50,50,50);this.scene.add(this.basic)},ground:function(){this.m=new THREE.Mesh(this.geo.ground,this.mat.base);this.m.scale.set(50,50,50);this.scene.add(this.m)},tell:function(a){this.info.innerHTML=a},addBlob:function(a,
b){var c=new V.Blob(this,a,b);this.meshs[this.meshs.length]=c},add:function(a){var b=new THREE.Mesh(this.geo[a.type||"box"],this.mat[a.mat||"base2"]);a.pos=a.pos||[0,0,0];a.size=a.size||[1,1,1];b.scale.set(a.size[0],a.size[1],a.size[2]);b.position.set(a.pos[0],a.pos[1],a.pos[2]);b.rotation.set(0,0,0);this.scene.add(b);this.meshs[this.meshs.length]=b;this.w&&this.w.add(a)},addParticle:function(a){var b=this.ps.length;this.ps[b]=new V.Particle(this,a);a.id=b;this.w&&this.w.addParticle(a)},initGeo:function(){var a=
{};a.sphere=(new THREE.BufferGeometry).fromGeometry(new THREE.SphereGeometry(1,12,10));a.sphereHigh=(new THREE.BufferGeometry).fromGeometry(new THREE.SphereGeometry(1,34,28));a.box=(new THREE.BufferGeometry).fromGeometry(new THREE.BoxGeometry(1,1,1));a.cylinder=(new THREE.BufferGeometry).fromGeometry(new THREE.CylinderGeometry(1,1,1,12,1));a.plane=new THREE.PlaneBufferGeometry(1,1);a.ground=new THREE.PlaneBufferGeometry(1,1);a.ground.applyMatrix((new THREE.Matrix4).makeRotationX(-V.PI90));this.geo=
a},initMat:function(){var a={};a.none=new THREE.MeshBasicMaterial({transparent:!0,opacity:0,fog:!1,depthTest:!1,depthWrite:!1});a.zone=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:0.1,fog:!1,depthTest:!1,depthWrite:!1});a.base=new THREE.MeshBasicMaterial({color:0});a.anchor=new THREE.MeshBasicMaterial({color:16724736});a.Sanchor=new THREE.MeshBasicMaterial({color:16777215});a.base2=new THREE.MeshBasicMaterial({color:65280,map:THREE.ImageUtils.loadTexture("images/grid1.jpg")});this.mat=
a},addWorker:function(a,b){this.w=new V.Worker(this,a);this.wFun=b||function(){}},addRenderTarget:function(a,b){var c=new THREE.WebGLRenderTarget(a,b,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat});this.isWithSerious=!0;return c},chaine:function(a){for(var b=a.close||!1,c=this.lines.length,d=new THREE.LineBasicMaterial({color:16737809}),e=new THREE.Geometry,g=0.5*a.points.length,f,h=0;h<g;h++)f=2*h,f=new THREE.Vector3(a.points[f],0,a.points[f+1]),e.vertices.push(f),
this.addAnchor(f,c,h,b);a.close&&e.vertices.push(new THREE.Vector3(a.points[0],0,a.points[1]));b=new THREE.Line(e,d);this.scene.add(b);this.lines[c]=b;this.w&&this.w.chaine(a)},addAnchor:function(a,b,c,d){var e=new THREE.Mesh(this.geo.box,this.mat.anchor);e.position.copy(a);e.name=d?"ca"+b+"_"+c:"oa"+b+"_"+c;this.base.add(e);this.anchors[e.name]=e},upAnchor:function(a){var b=a.name,c=b.lastIndexOf("_"),d=b.substring(2,c)||0,d=1*d,c=b.substring(c+1,b.length)||0,c=1*c,d=this.lines[d],e=d.geometry.vertices.length;
d.geometry.vertices[c].copy(a.position);"c"==b.substring(0,1)&&0==c&&d.geometry.vertices[e-1].copy(a.position);d.geometry.verticesNeedUpdate=!0;this.w&&(this.w.dr[2*c]=a.position.x,this.w.dr[2*c+1]=a.position.z,this.w.msg="updecal")}};V.Blob=function(a,b,c){THREE.Object3D.call(this);this.type="BLOB";this.root=a;a=this.root.geo.plane;var d=new THREE.MeshBasicMaterial({color:0});this.s1=new THREE.Mesh(a,d);c=2*(c||20);this.s1.scale.set(c,c,c);this.root.sceneBlob.add(this.s1);b&&this.position.copy(b)};
V.Blob.prototype=Object.create(THREE.Object3D.prototype);V.Blob.prototype.constructor=V.Blob;V.Blob.prototype._updateMatrix=V.Blob.prototype.updateMatrix;V.Blob.prototype.updateMatrix=function(){console.log("up");this._updateMatrix();null!=this.customMatrix&&this.matrix.multiply(this.customMatrix)};V.Blob.prototype.clear=function(){this.root.sceneBlob.remove(this.s1)};V.Blob.prototype.update=function(a){this.s1.position.copy(this.position);this.s1.rotation.copy(a)};
V.Nav=function(a,b,c,d){this.EPS=1E-6;this.root=a;this.cursor=new V.Cursor;this.lockView=!1;this.camera=new THREE.PerspectiveCamera(V.Resolution.f,this.root.dimentions.r,0.1,1E3);this.mouse3d=new THREE.Vector3;this.selectName="";this.rayVector=new THREE.Vector3(0,0,1);this.raycaster=new THREE.Raycaster;this.target=new THREE.Vector3;this.position=new THREE.Vector3;this.cam={horizontal:b||0,vertical:c||90,distance:d||20,automove:!1};this.mouse={x:0,y:0,ox:0,oy:0,h:0,v:0,mx:0,my:0,down:!1,move:!0,button:0};
this.key={up:0,down:0,left:0,right:0,ctrl:0,action:0,space:0,shift:0};this.moveCamera();this.root.canvas.oncontextmenu=function(a){a.preventDefault()};this.root.canvas.onclick=function(a){this.onMouseClick(a)}.bind(this);this.root.canvas.onmousemove=function(a){this.onMouseMove(a)}.bind(this);this.root.canvas.onmousedown=function(a){this.onMouseDown(a)}.bind(this);this.root.canvas.onmouseout=function(a){this.onMouseUp(a)}.bind(this);this.root.canvas.onmouseup=function(a){this.onMouseUp(a)}.bind(this);
this.root.canvas.onmousewheel=function(a){this.onMouseWheel(a)}.bind(this);this.root.canvas.onDOMMouseScroll=function(a){this.onMouseWheel(a)}.bind(this)};
V.Nav.prototype={constructor:V.Nav,moveCamera:function(){this.orbit();this.camera.position.copy(this.position);this.camera.lookAt(this.target)},orbit:function(){var a=this.position,b=this.cam.distance,c=this.cam.vertical*V.ToRad,d=this.cam.horizontal*V.ToRad,c=Math.max(this.EPS,Math.min(Math.PI-this.EPS,c));a.x=b*Math.sin(c)*Math.cos(d);a.y=b*Math.cos(c);a.z=b*Math.sin(c)*Math.sin(d);a.add(this.target)},move:function(a){this.target.copy(a);this.moveCamera()},moveto:function(a,b,c){this.target.set(a,
b,c);this.moveCamera()},onMouseClick:function(a){a.preventDefault();"function"==typeof mainClick&&mainClick()},onMouseDown:function(a){this.mouse.down=!0;this.mouse.button=a.which;this.mouse.ox=a.clientX;this.mouse.oy=a.clientY;this.mouse.h=this.cam.horizontal;this.mouse.v=this.cam.vertical;this.mouse.x=a.clientX;this.mouse.y=a.clientY;this.rayTest();"function"==typeof mainDown&&mainDown();a.preventDefault();a.stopPropagation()},onMouseUp:function(a){this.mouse.down=!1;this.cursor.change();"function"==
typeof mainUp&&mainUp();a.preventDefault();a.stopPropagation()},onMouseMove:function(a){this.mouse.down&&this.mouse.move&&!this.lockView&&(this.cursor.change("move"),this.cam.horizontal=0.3*(a.clientX-this.mouse.ox)+this.mouse.h,this.cam.vertical=0.3*-(a.clientY-this.mouse.oy)+this.mouse.v,0>this.cam.vertical&&(this.cam.vertical=0),this.moveCamera());this.mouse.x=a.clientX;this.mouse.y=a.clientY;this.rayTest();"function"==typeof mainMove&&mainMove();a.preventDefault();a.stopPropagation()},onMouseWheel:function(a){a.preventDefault();
var b=0;a.wheelDeltaY?b=0.01*a.wheelDeltaY:a.wheelDelta?b=0.05*a.wheelDelta:a.detail&&(b=1*-a.detail);this.cam.distance-=b;2>this.cam.distance&&(this.cam.distance=2);this.moveCamera()},rayTest:function(a){this.rayVector.x=this.mouse.x/this.root.dimentions.w*2-1;this.rayVector.y=2*-(this.mouse.y/this.root.dimentions.h)+1;this.rayVector.unproject(this.camera);this.raycaster.ray.set(this.camera.position,this.rayVector.sub(this.camera.position).normalize());a=this.raycaster.intersectObjects(this.root.base.children);
0<a.length?(this.selectName=a[0].object.name,this.mouse3d.copy(a[0].point),"function"==typeof mainRay&&mainRay(this.mouse3d,this.selectName)):this.selectName=""},bindKeys:function(){window.top.onkeydown=function(a){a=a||window.event;switch(a.keyCode){case 38:case 87:case 90:this.key.up=1;break;case 40:case 83:this.key.down=1;break;case 37:case 65:case 81:this.key.left=1;break;case 39:case 68:this.key.right=1;break;case 17:case 67:this.key.ctrl=1;break;case 69:this.key.action=1;break;case 32:this.key.space=
1;break;case 16:this.key.shift=1}}.bind(this);window.top.onkeyup=function(a){a=a||window.event;switch(a.keyCode){case 38:case 87:case 90:this.key.up=0;break;case 40:case 83:this.key.down=0;break;case 37:case 65:case 81:this.key.left=0;break;case 39:case 68:this.key.right=0;break;case 17:case 67:this.key.ctrl=0;break;case 69:this.key.action=0;break;case 32:this.key.space=0;break;case 16:this.key.shift=0}}.bind(this)},unwrapDegrees:function(a){a%=360;180<a&&(a-=360);-180>a&&(a+=360);return a}};
V.Cursor=function(){this.current="auto";this.type={drag:"url(images/cursor/hand.png) 16 16,auto",draw:"url(images/cursor/draw.png) 16 16,auto",cut:"url(images/cursor/cut.png) 0 30,auto",move:"move",auto:"auto"}};V.Cursor.prototype={constructor:V.Cursor,change:function(a){a=a||"auto";a!==this.current&&(this.current=a,document.body.style.cursor=this.type[this.current])}};var dat;V.Gui=function(a){this.gui=new dat.GUI;this.tmp={};a&&this.model3d()};
V.Gui.prototype={constructor:V.Gui,model3d:function(){this.gui.add(v,"model",V.MeshList).onChange(function(){v.addModel(shader)})},color:function(a,b){var c=this;this.tmp[a]=[255*b.r,255*b.g,255*b.b];this.gui.addColor(this.tmp,a).onChange(function(){shader.upColor(a,c.tmp[a])})},int:function(a,b){var c=this;this.tmp[a]=b?!0:!1;this.gui.add(this.tmp,a).onChange(function(){shader.upBool(a,c.tmp[a])})},float:function(a,b){var c=this;this.tmp[a]=b;this.gui.add(this.tmp,a).step(0.1).onChange(function(){shader.up(a,
c.tmp[a])})},textures:function(a){}};V.Environment=function(){this.shaders=[];this.envLists="e_chrome.jpg e_black.jpg e_brush.jpg e_metal.jpg e_plastic.jpg e_plastic_r.jpg e_smooth.jpg env.jpg env0.jpg env1.jpg".split(" ");this.nEnv=0;this.init()};
V.Environment.prototype={constructor:V.Environment,init:function(){var a=document.createElement("div");a.className="environment";var b=document.createElement("canvas");b.width=b.height=64;a.appendChild(b);this.envcontext=b.getContext("2d");a.onclick=function(){this.load()}.bind(this);document.body.appendChild(a);this.load()},load:function(){var a=new Image;a.onload=function(){this.nEnv++;this.nEnv==this.envLists.length&&(this.nEnv=0);this.envcontext.drawImage(a,0,0,64,64);this.environment=new THREE.Texture(a);
this.environment.needsUpdate=!0;for(var b=this.shaders.length;b--;)this.shaders[b].isActive&&(this.shaders[b].uniforms.env.value=this.environment)}.bind(this);a.src="images/spherical/"+this.envLists[this.nEnv]},add:function(a){this.shaders.push(a)}};V.Particle=function(a,b){this.root=a;var c=b.radius||0.25;this.geometry=new THREE.Geometry;this.material=new THREE.PointCloudMaterial({size:2*c,sizeAttenuation:!0,map:this.makeSprite(),transparent:!0});this.particles=new THREE.PointCloud(this.geometry,this.material);this.particles.sortParticles=!0;this.particles.dynamic=!0;for(c=b.n||0;c--;)this.addV();this.root.scene.add(this.particles)};
V.Particle.prototype={constructor:V.Particle,makeSprite:function(){var a=document.createElement("canvas");a.width=a.height=32;var b=a.getContext("2d"),c=0.5*a.width,d=0.5*a.height;b.beginPath();b.fillStyle="#FF0000";b.arc(c,d,16,0,2*Math.PI,!1);b.fill();a=new THREE.Texture(a);a.needsUpdate=!0;return a},getLength:function(){return this.particles.geometry.vertices.length},addNum:function(a){for(;a--;)this.addV();this.update()},addV:function(a,b,c){a=new THREE.Vector3(a||0,b||0,c||0);this.particles.geometry.vertices.push(a);
this.particles.geometry.dispose()},move:function(a,b,c,d){this.geometry.vertices[a]&&(this.geometry.vertices[a].x=b||0,this.geometry.vertices[a].y=c||0,this.geometry.vertices[a].z=d||0)},update:function(){this.geometry.verticesNeedUpdate=!0}};V.Point=function(a,b,c,d,e,g){this.x=a||0;this.y=b||0;this.z=c||0;this.r=d||0;this.c=e||0;this.s=g||0};V.SeaPool=function(){this.meshes={}};V.SeaPool.prototype={constructor:V.SeaPool,load:function(a,b,c){this.callback=b||function(){};var d="",e=new THREE.SEA3D(!0);e.onComplete=function(b){this.meshes[a]={};b=e.meshes.length;for(var f;b--;)f=e.meshes[b],this.meshes[a][f.name]=f,d+=f.name+",";c&&console.log(d);this.callback()}.bind(this);e.parser=THREE.SEA3D.DEFAULT;e.load("models/"+a+".sea")}};
V.ProjectUV=function(a,b){null===a.boundingBox&&a.computeBoundingBox();var c=a.boundingBox.max,d=a.boundingBox.min;b.uniforms.offset.value=new THREE.Vector2(0-d.x,0-d.z);b.uniforms.range.value=new THREE.Vector2(c.x-d.x,c.z-d.z)};V.TransGeo=function(a,b){a.mergeVertices();a.verticesNeedUpdate=!0;a.normalsNeedUpdate=!0;a.computeFaceNormals();a.computeVertexNormals(!0);a.computeTangents();if(b)return a;var c=(new THREE.BufferGeometry).fromGeometry(a);a.dispose();return c};V.PostEffect=function(a,b,c,d){this.shaderLoaded=0;this.root=a;this.name=b;this.isActive=!1;this.init(c);this.callback=d||function(){}};
V.PostEffect.prototype={constructor:V.PostEffect,init:function(a){var b=this.root.dimentions.w,c=this.root.dimentions.h;this.composer=new THREE.EffectComposer(this.root.renderer);this.renderModel=new THREE.RenderPass(this.root.scene,this.root.nav.camera);this.composer.addPass(this.renderModel);if("ssao"==this.name){if(this.isAdvancedSSAO=a||!1)this.oldMap=[],this.oldSkinMap=[],this.depthShader2=THREE.DepthDef,this.depthUniforms2=THREE.UniformsUtils.clone(this.depthShader2.uniforms),this.depthMaterial2=
new THREE.ShaderMaterial({fragmentShader:this.depthShader2.fragmentShader,vertexShader:this.depthShader2.vertexShader,uniforms:this.depthUniforms2,skinning:!0}),this.depthMaterial2.blending=THREE.NoBlending;this.depthShader=THREE.DepthDef;this.depthUniforms=THREE.UniformsUtils.clone(this.depthShader.uniforms);this.depthMaterial=new THREE.ShaderMaterial({fragmentShader:this.depthShader.fragmentShader,vertexShader:this.depthShader.vertexShader,uniforms:this.depthUniforms});this.depthMaterial.blending=
THREE.NoBlending;this.depthParam={minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,stencilBuffer:!1};this.depthTarget=new THREE.WebGLRenderTarget(b,c,this.depthParam);this.fxaa=new THREE.ShaderPass(THREE.FXAAShader);this.fxaa.uniforms.resolution.value.set(1/b,1/c);this.composer.addPass(this.fxaa);this.ao=new THREE.ShaderPass(THREE.SSAOShader);this.ao.uniforms.tDepth.value=this.depthTarget;this.ao.uniforms.size.value.set(b,c);this.ao.uniforms.cameraNear.value=this.root.nav.camera.near;
this.ao.uniforms.cameraFar.value=this.root.nav.camera.far;this.ao.needsSwap=!0;this.ao.renderToScreen=!0;this.composer.addPass(this.ao);this.isActive=this.root.renderer.autoClear=!0}"metaball"==this.name&&(this.shaderLoaded=0,a=function(){this.testShader()}.bind(this),this.gauss=new V.GaussTexture(64,1,0.067),this.blobxy=new V.Shader("Gauss_xy",{gauss:this.gauss,transparent:!0,blending:THREE.NormalBlending,depthTest:!1,depthWrite:!0},!1,a),this.blobmin=new V.Shader("Gauss_min",{gauss:this.gauss,transparent:!0,
blending:THREE.NormalBlending,depthTest:!1,depthWrite:!0},!1,a),this.metaball=new V.Shader("Metaball",{},!1,a))},testShader:function(){this.shaderLoaded++;if(3==this.shaderLoaded&&"metaball"==this.name){var a=this.root.dimentions.w,b=this.root.dimentions.h;this.glowParameters={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBufer:!1};this.glowTargetxy=new THREE.WebGLRenderTarget(a,b,this.glowParameters);this.renderModelGlowxy=new THREE.RenderPass(this.root.sceneBlob,
this.root.nav.camera,this.blobxy);this.glowcomposerxy=new THREE.EffectComposer(this.root.renderer,this.glowTargetxy);this.glowcomposerxy.addPass(this.renderModelGlowxy);this.glowTarget=new THREE.WebGLRenderTarget(a,b,this.glowParameters);this.renderModelGlow=new THREE.RenderPass(this.root.sceneBlob,this.root.nav.camera,this.blobmin);this.glowcomposer=new THREE.EffectComposer(this.root.renderer,this.glowTarget);this.glowcomposer.addPass(this.renderModelGlow);this.renderTarget=new THREE.WebGLRenderTarget(a,
b,this.glowParameters);this.meta=new THREE.ShaderPass(this.metaball);this.meta.uniforms.tDiffuseXY.value=this.glowcomposerxy.renderTarget2;this.meta.uniforms.tDiffuseMin.value=this.glowcomposer.renderTarget2;this.meta.uniforms.size.value.set(a,b);this.meta.transparent=!0;this.meta.uniforms.env.value=THREE.ImageUtils.loadTexture("./images/spherical/env0.jpg");this.meta.isActive=!0;this.meta.needsSwap=!0;this.meta.renderToScreen=!0;this.composer.addPass(this.renderTarget);this.composer.addPass(this.meta);
this.isActive=!0;this.callback()}},render:function(){var a=this.root;if("ssao"==this.name)if(this.isAdvancedSSAO){for(var b=a.skinned.children.length,c=a.content.children.length,d=c;d--;)this.oldMap[d]||(this.oldMap[d]=a.content.children[d].material),a.content.children[d].material=this.depthMaterial;for(d=b;d--;)this.oldSkinMap[d]||(this.oldSkinMap[d]=a.skinned.children[d].material),a.skinned.children[d].material=this.depthMaterial2;a.renderer.render(a.scene,a.nav.camera,this.depthTarget);for(d=c;d--;)a.content.children[d].material=
this.oldMap[d];for(d=b;d--;)a.skinned.children[d].material=this.oldSkinMap[d]}else a.scene.overrideMaterial=this.depthMaterial,a.renderer.render(a.scene,a.nav.camera,this.depthTarget),a.scene.overrideMaterial=null;if("metaball"==this.name){b=a.nav.camera.rotation;for(d=a.meshs.length;d--;)c=a.meshs[d],"BLOB"==c.type&&c.update(b);this.glowcomposerxy.render();this.glowcomposer.render()}this.composer.render()},resize:function(a,b){"ssao"==this.name&&(this.depthTarget=new THREE.WebGLRenderTarget(a,b,
this.depthParam),this.ao.uniforms.tDepth.value=this.depthTarget,this.ao.uniforms.size.value.set(a,b),this.fxaa.uniforms.resolution.value.set(1/a,1/b));"metaball"==this.name&&this.meta.uniforms.size.value.set(a,b);this.composer.setSize(a,b)},deformSsao:function(a,b){a.computeBoundingBox();var c=a.boundingBox.max,d=a.boundingBox.min;this.depthUniforms.tdeep.value=b;this.depthUniforms.offset.value=new THREE.Vector2(0-d.x,0-d.z);this.depthUniforms.range.value=new THREE.Vector2(c.x-d.x,c.z-d.z)}};
V.GaussTexture=function(a,b,c){this.sets={size:a||64,height:b||1,deviation:c||0.067};return this.createGaussTexture()};
V.GaussTexture.prototype={createGaussTexture:function(){var a=new Uint8Array(this.sets.size*this.sets.size*3),b,c,d,e;for(e=this.sets.size;e--;)for(d=this.sets.size;d--;)b=2*d/this.sets.size-1,c=2*e/this.sets.size-1,b=this.sets.height*Math.exp(-(b*b+c*c)/this.sets.deviation),b*=255,c=3*(e*this.sets.size+d),a[c+0]=b,a[c+1]=b,a[c+2]=b;a=new THREE.DataTexture(a,this.sets.size,this.sets.size,THREE.RGBFormat);a.wrapS=a.wrapT=THREE.ClampToEdgeWrapping;a.needsUpdate=!0;return a}};V.Shader=function(a,b,c,d){this.isEdit=c||!1;THREE.ShaderMaterial.call(this,b);this.visible=this.isActive=!1;this.parameters=b;this.callback=d||function(){};this.oldUniforms=null;this.loading(a,b)};V.Shader.prototype=Object.create(THREE.ShaderMaterial.prototype);V.Shader.prototype.constructor=V.Shader;V.Shader.prototype.editor=function(a){window.top.main.shader.open(a)};V.Shader.prototype.up=function(a,b){this.uniforms[a]&&(this.uniforms[a].value=b)};
V.Shader.prototype.upColor=function(a,b){this.uniforms[a]&&this.uniforms[a].value.setRGB(b[0]/255,b[1]/255,b[2]/255)};V.Shader.prototype.upBool=function(a,b){this.uniforms[a]&&(this.uniforms[a].value=b?1:0)};V.Shader.prototype.init=function(a){this.setValues(a)};V.Shader.prototype.updateShader=function(a){this.oldUniforms=this.uniforms;this.dispose();this.isActive=!1;a=eval(a);this.apply(a,!0)};
V.Shader.prototype.apply=function(a,b){if(b)this.uniforms=this.oldUniforms;else{this.uniforms=THREE.UniformsUtils.clone(a.uniforms);for(var c in this.parameters)this.uniforms[c]&&(this.uniforms[c].value=this.parameters[c])}this.vertexShader=a.vs;this.fragmentShader=a.fs;this.visible=this.isActive=this.needsUpdate=!0;b||this.callback()};
V.Shader.prototype.loading=function(a){var b;window.XMLHttpRequest?b=new XMLHttpRequest:window.ActiveXObject&&(b=new ActiveXObject("Microsoft.XMLHTTP"));b.onload=function(c){c=eval(b.responseText);this.apply(c);this.isEdit&&window.top.main.shader.pushShader(a,c)}.bind(this);b.open("GET","shaders/"+a+".js",!0);b.send()};
V.LoadShader=function(a){var b;window.XMLHttpRequest?b=new XMLHttpRequest:window.ActiveXObject&&(b=new ActiveXObject("Microsoft.XMLHTTP"));b.onload=function(a){return eval(b.responseText)};b.open("GET","shaders/"+a+".js",!0);b.send()};V.Worker=function(a,b){this.name=b;this.root=a;this.msg="";this.postMess=this.update=null;var c,d,e,g,f,h,k;switch(this.name){case "crowd":c="js/worker/crowd_worker.js";d=1E3;e=100;g=10;f=1E3;h=3;k=2;this.update=this.upCrowd;this.postMess=this.postCrowd;break;case "liquid":c="js/worker/liquid_worker.js";d=1E3;e=100;g=10;f=1E3;h=4;k=2;this.update=this.upLiquid;this.postMess=this.postLiquid;break;case "oimo":c="js/worker/oimo_worker.js",d=1E3,g=e=10,f=0,h=8,k=3,this.update=this.upOimo,this.postMess=
this.postOimo}this.w=new Worker(c);this.w.postMessage=this.w.webkitPostMessage||this.w.postMessage;this.w.onmessage=function(a){this.update(a)}.bind(this);this.ar=new V.AR32(d*h);this.dr=new V.AR32(e*k);this.pr=new V.AR32(f*k);this.drn=new V.AR8(g);this.drc=new V.AR8(g);this.prn=new V.AR8(g);this.d=[16.667,0,0];this.isReady=!1;this.fps=0;this.loop()};
V.Worker.prototype={constructor:V.Worker,clear:function(){this.w.terminate()},computeTime:function(){this.root.deb=" | "+this.name+" "+this.fps+" fps ";var a=this.d;a[1]=a[0]-(Date.now()-a[2]);a[1]=0>a[1]?0:a[1];setTimeout(function(){this.d[2]=Date.now();this.postMess();this.msg=""}.bind(this),a[1])},loop:function(){this.d[2]=Date.now();this.postMess();this.msg=""},upCrowd:function(a){this.fps=a.data.fps;this.ar=a.data.ar;a=this.root.meshs;for(var b=a.length,c;b--;)c=3*b,a[b].position.x=this.ar[c],
a[b].position.z=this.ar[c+1],a[b].rotation.y=this.ar[c+2];this.computeTime()},postCrowd:function(){this.w.postMessage({m:"run",ar:this.ar},[this.ar.buffer])},upLiquid:function(a){a.data.w&&!this.isReady&&(this.isReady=!0);this.fps=a.data.fps;this.ar=a.data.ar;this.pr=a.data.pr;this.prn=a.data.prn;var b=this.root.meshs;a=b.length;for(var c;a--;)c=4*a,b[a].position.x=this.ar[c],b[a].position.z=this.ar[c+1],b[a].rotation.y=this.ar[c+2];a=this.root.ps.length;for(var d;a--;){b=this.root.ps[a];c=this.prn[a];
b.getLength()!==c&&b.addNum(c);for(d=c;d--;)c=2*d,b.move(d,this.pr[c],0,this.pr[c+1]);b.update()}this.computeTime()},postLiquid:function(){this.w.postMessage({m:"run",m2:this.msg,drn:this.drn,drc:this.drc,dr:this.dr,ar:this.ar,pr:this.pr,prn:this.prn},[this.ar.buffer,this.pr.buffer])},upOimo:function(a){a.data.w&&!this.isReady&&(this.isReady=!0);this.fps=a.data.fps;this.ar=a.data.ar;a=this.root.meshs;for(var b=a.length,c;b--;)c=8*b,this.ar[c]&&(a[b].position.set(this.ar[c+1],this.ar[c+2],this.ar[c+
3]),a[b].quaternion.set(this.ar[c+4],this.ar[c+5],this.ar[c+6],this.ar[c+7]));this.computeTime()},postOimo:function(){this.w.postMessage({m:"run",m2:this.msg,drn:this.drn,drc:this.drc,ar:this.ar,dr:this.dr},[this.ar.buffer])},add:function(a){this.w.postMessage({m:"add",obj:a})},addParticle:function(a){this.w.postMessage({m:"addParticle",obj:a})},post:function(a){this.w.postMessage(a)},chaine:function(a){a.close&&(this.drc[0]=1);var b=0.5*a.points.length;this.drn[0]=b;for(var c,d=0;d<b;d++)c=2*d,this.dr[c]=
a.points[c],this.dr[c+1]=a.points[c+1];this.msg="updecal"}};
